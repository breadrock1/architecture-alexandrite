# Мониторинг. Выбор и настройка мониторинга в системе

По условию количество пользователей растет линейно. На текущий момент возникла потребность в управлении трафиком и 
масштабировании отдельных компонентов системы. Пользователи наблюдают медленную работу системы, а также отсутствие 
своих заказов, что говорит о потери данных в системе.

Правильно настроенный мониторинг позволит во-время обнаруживать перегрузки ресурсов и принимать меры для ограничения
потока а затем масштабировать нагруженный сервис.

## Потенциальные узкие места, нуждающиеся в мониторинге
1. Internet Shop, Shop API - загруженность формируется в случае одновременного редактирования сложных 3D схем большим 
   количестовом клиентов в пиковые часы;
2. Messages Queue - может накапливать большое количество запросов в часы пиковой нагрузки от клиентов, которые будут; 
   рассасываться в часы пониженной нагрузки, важно чтобы заполнение очереди клиентскими запросами не влияло на обработку 
   запросов от MES и соответсвенно не мешало работе операторов;
3. Поскольку количество операторов фиксированное и темпы их работы примерно известны нагрузка на MES и соответсвующие 
   топики Messages Queue  поддается расчетной оценке, однако любой расчет может оказаться ошибочным, поэтому для проверки 
   поток запросов к/от MES нужно периодически мониторить;
4. Мониторинг запросов к БД  и files storage может понадобиться в случае выявления узкого места в  сервисе для дальнейшей локализации причин;
5. Судя по описанию проблематики, с CRM проблем не возникает, в этой части можно сэкономить на мониторинге.

# Выбор подхода к мониторингу
1. Internet Shop, Shop API - количество запросов и продолжительность обработки запросов, количество одновременно работающий 
   пользователей - применяем метод RED ориентированный на оценку "здоровья" сервисов;
2. Messages Queue - перцентили задержек в очередях - метод 4 золотых сигнала;
3. MES - количество одновременно работающих операторов, продолжительность обработки операций-  метод RED, расход оперативной 
   памяти, загруженность процессоров - метод USE;
4. Мониторинг запросов к БД  и files storage - загрузка серверных ресурсов - метод USE.

Предполагается настроить 2 уровня мониторинга - отладочный на период активной диагностики проблем с расширенным составом 
метрик и базовый на постоянной основе для упреждения возникновения проблем с минимальныо-достаточным составом метрик.

# Выбор метрик
1. Internet Shop, Shop API
 - Number of requests (RPS) for internet shop API
 - Number of requests (RPS) per user for internet shop API
 - Response time (latency) for shop API
 - Number of HTTP 500 for shop API

2. Messages Queue - перцентили задержек в очередях и обращениях к API
 - Number of dead-letter-exchange letters in RabbitMQ
 - Number of message in flight in RabbitMQ
 - Response time (latency) for MES API
 - Response time (latency) for CRM API

3. MES - количество одновременно работающих операторов, продолжительность обработки операций^  расход оперативной памяти, загруженность процессоров
 - Number of requests (RPS) for MES API
 - Number of requests (RPS) per user for MES API
 - Memory Utilisation for MES API
 - CPU % for MES API
 - Kb tranferred (received) for MES API
 - Kb provided (sent) for MES API

4. Мониторинг запросов к БД  и files storage
 - Size of S3 storage
 - Size of shop db instance
 - Size of MES db instance
 - Response time (latency)of shop db instance
 - Response time (latency)of MES db instance
 - Response time (latency)of S3 storage

# План действий
1. Настроить мониторинг в режиме диагностики - все метрики описанные выше, выявить узкие места и ошибки приводящие к потере данных
2. Настроить масштабирование сервисов не справившихся с нагрузкой и при необходимости кэш баз данных
3. Оставить мониторинг в базовом режиме , а именно метрики п 2 и CPU % for MES API из п.3, Response time (latency)  из п.4
4. Доработать Shop API  в части фильтрации данных в запросах к БД

# Показатели насыщенности
В базовом режиме мониторинга должны контролироваться следующие показатели насыщенности:
 - Number of dead-letter-exchange letters in RabbitMQ
 - Number of message in flight in RabbitMQ

При превышении данных показателей необходимо включить диагностический режим мониторинга и трейсинг для локализации 
проблем вызвавших переполнение очередей:
 - Response time (latency) for MES API
 - Response time (latency) for CRM API

При превышении данных показателей необходимо проанализировать указанные ниже метрики на предмет локазизации причин 
задержек, если информации не достаточно, включить  трейсинг кода реализации API:
 - CPU % for MES API
 - Response time (latency)of shop db instance
 - Response time (latency)of MES db instance
 - Response time (latency)of S3 storage
